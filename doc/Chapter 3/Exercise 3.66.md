## [Chapter 3](../index.md#3-Modularity-Objects-and-State)

### [Exercise 3.66](https://mitpress.mit.edu/sites/default/files/sicp/full-text/book/book-Z-H-24.html#%_thm_3.66)

Examine the stream `(pairs integers integers)`. Can you make any general comments about the order in which the pairs are placed into the stream? For example, about how many pairs precede the pair (1,100)? the pair (99,100)? the pair (100,100)? (If you can make precise mathematical statements here, all the better. But feel free to give more qualitative answers if you find yourself getting bogged down.)

### Solution

Вспомним, на какие части можно раделить поток, являющийся результатом работы `pairs`. В каждой итерации вызова `pairs` элементы из второй части будут пояляться в потоке примерно в половине случаев (не будем считать первый элемент потока, являющийся первой частью результата), оставаяся половина приходится на третью часть, т.е. на результат всех остальных итераций. Из этого можно вывести, что в итоговом потоке элементы (1, 2), (1, 3), ... встретятся в половине случаев, элементы (2, 2), (2, 3), ... в четверти случаев и т.д.

(1, 100) находится во второй части первой итерации. Соорудил такую табличку, чтобы посмотреть примерный порядок элмементов потока первой и второй части:

```
(1 2) (1 3) (1 4) (1 5) (1 6) (1 7)
(2 2) (2 3) (3 3) (2 4) (3 4) (2 5)
```

Табличка привела к формуле `(j - 1) * 2 - 1`, где `j`, это второй элемент в паре. Попробуем вычислить количество элементов в потоке перед нашим элементом.

```
(100 - 1) * 2 - 1 = 197
```

Дальше не мог ничего придумать, пока не построил другую таблицу:

```
    1   2   3   4   5   6   7   8   9 ...
  ———————————————————————————————————
1|  1   2   4   6   8  10  12  14  16
2|      3   5   9  13  17  21  25  29 33 37 41 45 49 53 ... (+ 4)
3|          7  11  19  27  35  43  51 59 67 75 83 91 99 ... (+ 8)
4|             15  23  39  55  71  87 103 ... (+ 16)
5|                 31  47  79 111 143 175 ... (+ 32)
6|                     63  95 159 223 287 ... (+ 64)
7|                        127 191 319 447 ... (+ 128)
8|                            255 383 639 ... (+ 256)
9|                                511 767 ... (+ 512)
...
```

Получилось найти способ определить порядок элементов в потоке. Если i = j:

```
2^i - 1
```

Если i < j:

```
2^i * (j - i) + (2^(i - 1) - 1)
```

---

Посчитаем, сколько пар предшествует (99, 100):

```
(2^99 * 1 + 2^98 - 1) - 1
~ 9.50737950171172e+29
```

Сколько пар предшествует (100, 100):

```
(2^100 - 1) - 1
~ 1.2676506002282294e+30
```

